name: OpenCode Review Fix

on:
  issue_comment:
    types: [created]

jobs:
  opencode-review-fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/opencode-review-fix') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.issue.number }}
      cancel-in-progress: true
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      checks: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: true

      - name: Install OpenCode CLI
        run: curl -fsSL https://opencode.ai/install | bash
        env:
          VERSION: 0.15.30

      - name: Checkout PR Branch
        run: gh pr checkout ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.5.0
          args: --version
          skip-cache: false
          install-mode: binary

      - name: Run OpenCode Review Fix
        timeout-minutes: 30
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT_FILE="Github_Development_Prompt_Grok.md"
          if [ -f "$PROMPT_FILE" ]; then
            BASE_PROMPT=$(cat "$PROMPT_FILE")
          else
            BASE_PROMPT="You are Grok, an AI assistant specialized in GitHub repository management and development tooling."
          fi

          TASK_PROMPT="Fix all review issues in this PR systematically.

          Protocol:
          1. Use 'gh pr view ${{ github.event.issue.number }} --comments' to read all review comments
          2. Use 'gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/reviews' for structured data
          3. Fix each issue one at a time with validation after each fix
          4. Run 'go mod tidy && go build ./... && make fmt && make lint && make test' after each fix
          5. Commit and push changes when all issues are resolved

          Requirements:
          - Fix issues from CodeRabbit, OpenCode, and other reviewers
          - Maintain or improve code coverage
          - Follow Go best practices
          - No new linting issues

          Current PR: #${{ github.event.issue.number }}
          Repository: ${{ github.repository }}"

          FULL_PROMPT="$BASE_PROMPT

          $TASK_PROMPT"

          opencode run --model opencode/grok-code "$FULL_PROMPT"

      - name: Post-OpenCode Go Validation
        run: |
          echo "üîç Running Go-specific validation after OpenCode's changes..."

          echo "üì¶ Fixing dependencies..."
          go mod tidy

          echo "üî® Testing compilation..."
          go build ./...

          echo "üß™ Running tests..."
          make test

          echo "üîç Running linter..."
          make lint

          echo "‚úÖ All Go validations passed"
